<script setup lang="ts">
import { get, useIntervalFn } from '@vueuse/core';
import { storeToRefs } from 'pinia';
import { type TableColumn } from '@rotki/ui-library/dist/components/tables/DataTable.vue';
import { useMainStore } from '~/store';
import { type Subscription } from '~/types';

const { t } = useI18n();

const headers: TableColumn[] = [
  {
    label: t('common.plan'),
    key: 'planName',
    cellClass: 'font-bold',
    class: 'capitalize',
  },
  {
    label: t('account.subscriptions.headers.created'),
    key: 'createdDate',
    sortable: true,
  },
  {
    label: t('account.subscriptions.headers.next_billing'),
    key: 'nextActionDate',
    sortable: true,
  },
  {
    label: t('account.subscriptions.headers.cost_in_symbol_per_period', {
      symbol: 'â‚¬',
    }),
    key: 'nextBillingAmount',
    sortable: true,
    align: 'end',
  },
  { label: t('common.status'), key: 'status', class: 'capitalize' },
  {
    label: t('common.actions'),
    key: 'actions',
    align: 'end',
    class: 'capitalize',
  },
];

const store = useMainStore();
const { subscriptions } = storeToRefs(store);
const pending = computed(() => get(subscriptions).filter((sub) => sub.pending));

const renewableSubscriptions = computed(() =>
  get(subscriptions).filter(({ actions }) => actions.includes('renew')),
);

const pendingPaymentCurrency = computedAsync(async () => {
  const subs = get(renewableSubscriptions);
  if (subs.length === 0) {
    return undefined;
  }
  const response = await store.checkPendingCryptoPayment(subs[0].identifier);

  if (response.isError || !response.result.pending) {
    return undefined;
  }

  return response.result.currency;
});

const renewLink = computed<{ path: string; query: Record<string, string> }>(
  () => {
    const link = {
      path: '/checkout/payment-method',
      query: {},
    };

    const subs = get(renewableSubscriptions);

    if (subs.length > 0) {
      const sub = subs[0];
      link.query = {
        p: sub.durationInMonths.toString(),
        id: sub.identifier,
      };
    }

    if (isDefined(pendingPaymentCurrency)) {
      link.query = {
        ...link.query,
        c: get(pendingPaymentCurrency),
      };
    }

    return link;
  },
);

const { pause, resume, isActive } = useIntervalFn(
  async () => await store.getAccount(),
  60000,
);

watch(pending, (pending) => {
  if (pending.length === 0) {
    pause();
  } else if (!get(isActive)) {
    resume();
  }
});

onUnmounted(() => pause());

const hasAction = (sub: Subscription, action: 'renew' | 'cancel') => {
  if (action === 'cancel') {
    return sub.status !== 'Pending' && sub.actions.includes('cancel');
  } else if (action === 'renew') {
    return sub.actions.includes('renew');
  }
  return false;
};

const displayActions = (sub: Subscription) =>
  hasAction(sub, 'renew') || hasAction(sub, 'cancel');

const getChipStatusColor = (status: string) =>
  ({
    Active: 'success',
    Canceled: 'error',
    Pending: 'warning',
    'Past Due': 'warning',
  })[status];

const pagination = ref({ limit: 10, page: 1 });
</script>

<template>
  <div>
    <div class="text-h6 mb-6">
      {{ t('account.subscriptions.title') }}
    </div>
    <RuiDataTable
      :pagination="{ ...pagination, total: subscriptions.length }"
      class="border rounded-xl"
      :cols="headers"
      :rows="subscriptions"
      :empty="{
        description: t('account.subscriptions.no_subscriptions_found'),
      }"
      row-attr="identifier"
      @update:pagination="pagination = $event"
    >
      <template #item.status="{ row }">
        <RuiChip size="sm" :color="getChipStatusColor(row.status)">
          {{ row.status }}
        </RuiChip>
      </template>

      <template #item.actions="{ row }">
        <div v-if="displayActions(row)" class="flex gap-2 justify-end">
          <CancelSubscription
            v-if="hasAction(row, 'cancel')"
            :subscription="row"
          />
          <ButtonLink
            v-if="hasAction(row, 'renew')"
            :to="renewLink"
            color="primary"
          >
            {{ t('actions.renew') }}
          </ButtonLink>
        </div>
        <div v-else class="capitalize">{{ t('common.none') }}</div>
      </template>
    </RuiDataTable>
  </div>
</template>
